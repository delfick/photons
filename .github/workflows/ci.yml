---

name: CI tasks

on: push

jobs:
  tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest] # TODO: make this pass on github hosted windows: , windows-latest]
        python-version: [3.6, 3.7, 3.8, 3.9]
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Display Python version
        run: python -c "import sys; print(sys.version)"

      - name: Install deps
        shell: bash
        run: |
          set -e
          python -m pip install --user --upgrade pip
          python -m pip install -e "modules[tests]"
          python -m pip install -e "apps/interactor"

      - name: Run module tests
        shell: bash
        run: cd modules && ./test.sh -v

      - name: Run interactor tests
        shell: bash
        run: cd apps/interactor && ./test.sh -v

  interactor_docker:
    needs: tests
    environment: docker
    runs-on: ubuntu-latest
    if: contains(github.ref, 'refs/tags/interactor-')
    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        with:
          python-version: 3.9

      - run: python3 -m pip install venvstarter

      - name: Enable experimental features for the Docker daemon and CLI
        run: |
          echo $'{\n  "experimental": true\n}' | sudo tee /etc/docker/daemon.json
          mkdir -p ~/.docker
          echo $'{\n  "experimental": "enabled"\n}' | sudo tee ~/.docker/config.json
          sudo service docker restart
          docker version -f '{{.Client.Experimental}}'
          docker version -f '{{.Server.Experimental}}'
          docker buildx version

      - name: Create the container
        run: ./apps/interactor/docker/create_container.sh
        env:
          CYPRESS_VIDEO: false
          DOCKER_PLATFORM: linux/386,linux/arm64,linux/amd64,linux/arm/v7,linux/arm/v6 
          TARGET_IMAGE: delfick/lifx-photons-interactor
          DOCKER_TOKEN: ${{ secrets.DOCKER_TOKEN }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
