---

context:
  use_gitignore: true

image_index: delfick/

images:
  lifx-photons-interactor:
    context:
      parent_dir: "{config_root}/../../../"

    commands:
      - FROM python:3.9-slim

      - ADD apps/interactor /project/interactor
      - ADD modules /project/modules
      - RUN ln -s /project/interactor/command /project/command

      - WORKDIR /project/config

      - - RUN
        - apt-get update
          && apt-get install curl gcc g++ -y
          && pip install pip -U && pip install /project/modules /project/interactor
          && apt-get purge -y gcc g++
          && apt-get autoremove -y
          && rm -rf /var/lib/apt/lists/*

      - ENV INTERACTOR_HOST 0.0.0.0
      - HEALTHCHECK CMD lifx interactor_healthcheck --silent || exit 1
      - CMD ["lifx", "lan:interactor"]

  lifx-photons-interactor-homeassistant:
    context:
      parent_dir: "{config_root}/../../../"

    commands:
      - ARG BUILD_FROM
      - FROM $BUILD_FROM

      - RUN apk add --no-cache python3 py3-pip gcc python3-dev musl-dev linux-headers g++

      - ADD apps/interactor /project/interactor
      - ADD modules /project/modules

      - RUN pip install /project/modules /project/interactor

      - WORKDIR /config/photons

      - - ADD
        - dest: /run.sh
          content: |
            #!/usr/bin/with-contenv bashio

            CONFIG="$(bashio::config 'config')"
            echo "$CONFIG" >config.json

            lifx lan:interactor

      - RUN chmod a+x /run.sh

      - CMD [ "/run.sh" ]
